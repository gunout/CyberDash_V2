<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEATSTREET CYBERDASH - Selection Manager</title>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-cyan: #00ffff;
            --neon-blue: #00f3ff;
            --dark-cyan: #0088aa;
            --accent-blue: #0099ff;
            --bg-dark: #020205;
            --bg-panel: rgba(5, 15, 30, 0.9);
            --text-primary: #e0faff;
            --text-secondary: #00cccc;
            --danger-red: #ff3333;
            --glow-cyan: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 20px rgba(0, 255, 255, 0.4);
            --glow-strong: 0 0 15px var(--neon-blue), 0 0 30px var(--primary-cyan);
        }

        body {
            background: linear-gradient(135deg, #020205 0%, #050a15 50%, #0a0f20 100%);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        /* Background Effects */
        .cyber-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index:1; }
        .particle {
            position: absolute; width: 2px; height: 2px; background: var(--primary-cyan);
            border-radius: 50%; box-shadow: var(--glow-cyan); animation: float 20s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }
        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0,255,255, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0,255,255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none; z-index: 2;
        }

        /* Layout */
        .dashboard {
            position: relative; z-index: 10;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(0, 20, 30, 0.7); border: 1px solid var(--primary-cyan);
            border-radius: 10px; padding: 15px 25px; backdrop-filter: blur(15px);
            box-shadow: var(--glow-cyan); display: flex; justify-content: space-between; align-items: center;
        }
        .logo {
            font-family: 'Orbitron', monospace; font-size: 24px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, var(--primary-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .status-bar { display: flex; gap: 15px; font-family: 'Orbitron', monospace; font-size: 12px; }
        .status-item { color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: var(--primary-cyan); border-radius: 50%; box-shadow: var(--glow-cyan); }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr 250px;
            gap: 20px;
            min-height: 0; 
        }

        /* Panels */
        .panel {
            background: var(--bg-panel); border: 1px solid var(--dark-cyan);
            border-radius: 10px; padding: 15px; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Panel Title avec bouton Select All */
        .panel-title {
            font-family: 'Orbitron', monospace; font-size: 14px; font-weight: 700;
            color: var(--primary-cyan); margin-bottom: 15px; border-bottom: 1px solid var(--dark-cyan);
            padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Bouton Select All */
        .select-all-btn {
            background: transparent;
            border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .select-all-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px var(--primary-cyan);
        }

        .select-all-btn i {
            font-size: 10px;
        }

        /* Playlist Container & Scrollbar */
        .playlist-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 15px;
            padding-right: 5px;
        }
        
        .playlist-container::-webkit-scrollbar { width: 10px; }
        .playlist-container::-webkit-scrollbar-track {
            background: rgba(0, 20, 40, 0.6);
            border-radius: 5px;
        }
        .playlist-container::-webkit-scrollbar-thumb {
            background: var(--dark-cyan);
            border-radius: 5px;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .playlist-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-cyan);
            box-shadow: 0 0 10px var(--primary-cyan);
        }

        /* Playlist Item */
        .playlist-item {
            background: rgba(0,255,255, 0.03); border-left: 3px solid var(--dark-cyan);
            padding: 10px; margin-bottom: 5px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 10px;
            position: relative;
        }
        
        /* Checkbox Style */
        .cyber-check {
            width: 18px; height: 18px;
            border: 1px solid var(--primary-cyan);
            background: rgba(0, 0, 0, 0.5);
            cursor: pointer;
            position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .cyber-check:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 10px var(--primary-cyan);
        }

        /* Checked State */
        .cyber-check.checked {
            background: var(--primary-cyan);
            box-shadow: 0 0 10px var(--primary-cyan);
        }

        .cyber-check.checked::after {
            content: '✓';
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }

        /* Delete Button */
        .delete-btn {
            opacity: 0;
            background: var(--danger-red);
            color: #fff;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: absolute;
            right: -10px;
        }

        .playlist-item:hover .delete-btn {
            opacity: 1;
            right: 10px;
        }

        .delete-btn:hover {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--danger-red);
        }

        .playlist-item:hover {
            background: rgba(0,255,255, 0.1);
            border-left-color: var(--primary-cyan);
            transform: translateX(2px);
        }

        .playlist-item.active {
            background: rgba(0,255,255, 0.15); border-left-color: #fff;
            box-shadow: 0 0 10px rgba(0,255,255,0.1);
        }

        /* Track Info */
        .track-info-wrapper {
            flex: 1;
            min-width: 0;
            display: flex; flex-direction: column; gap: 4px;
        }

        .track-path {
            font-size: 11px; color: var(--text-secondary); opacity: 0.8;
            font-family: monospace; display: flex; align-items: center; gap: 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-path i { color: var(--primary-cyan); font-size: 10px; }
        
        .track-name {
            font-size: 13px; font-weight: 600; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 8px;
        }

        /* ZIP Button */
        .download-zip-btn {
            background: linear-gradient(45deg, var(--primary-cyan), var(--accent-blue));
            border: none; color: #000; padding: 12px; border-radius: 5px;
            font-family: 'Orbitron'; font-weight: 700; cursor: pointer; text-transform: uppercase;
            font-size: 12px; box-shadow: var(--glow-cyan); transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            flex-shrink: 0;
        }
        .download-zip-btn:hover { transform: translateY(-2px); box-shadow: var(--glow-strong); }
        .download-zip-btn small { font-size: 10px; opacity: 0.8; }

        /* Center Media Deck */
        .media-deck { flex: 1; display: flex; flex-direction: column; }
        
        .deck-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .cyber-input {
            flex:1; background: rgba(0, 10, 20, 0.9); border: 1px solid var(--dark-cyan);
            border-radius: 4px; padding: 10px; color: var(--primary-cyan);
            font-family: 'Rajdhani', sans-serif; font-size: 14px; outline: none;
        }
        .cyber-btn {
            background: rgba(0,255,255, 0.1); border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan); padding: 0 20px; border-radius: 4px; cursor: pointer;
            font-family: 'Orbitron', monospace; font-weight: 700; text-transform: uppercase;
            transition: all 0.3s;
        }
        .cyber-btn:hover { background: var(--primary-cyan); color: #000; box-shadow: var(--glow-cyan); }

        /* The Visual Screen */
        .screen-container {
            flex: 1; background: #000; border: 1px solid var(--dark-cyan); border-radius: 8px;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 20;
        }
        .corner-decor {
            position: absolute; width: 15px; height: 15px; border: 2px solid var(--primary-cyan);
            opacity: 0.5; z-index: 21;
        }
        .tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        .screen-content {
            flex: 1; position: relative; display: none; justify-content: center; align-items: center;
        }
        .screen-content.active { display: flex; }

        /* YouTube Mode */
        .yt-placeholder { 
            position: absolute; 
            text-align: center; 
            color: var(--dark-cyan); 
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.9);
        }
        .yt-placeholder i { font-size: 50px; margin-bottom: 15px; opacity: 0.3; }
        
        /* Container pour le lecteur YouTube */
        .yt-player-container {
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 10;
        }

        .yt-player-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Audio Mode */
        .audio-player-ui {
            width: 100%; padding: 20px; text-align: center; color: var(--primary-cyan);
            display: flex; flex-direction: column; justify-content: center; gap: 20px; height: 100%;
        }
        .audio-info-title { font-family: 'Orbitron'; font-size: 18px; text-shadow: 0 0 10px var(--primary-cyan); word-break: break-all; }
        .audio-info-path { font-family: 'Rajdhani'; font-size: 14px; opacity: 0.7; }
        
        .audio-wave {
            height: 100px; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .bar { width: 10px; background: var(--primary-cyan); animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 10px; opacity: 0.5; } 50% { height: 80px; opacity: 1; box-shadow: 0 0 10px var(--primary-cyan); } }
        
        /* Controls Bar */
        .control-bar {
            background: rgba(0, 20, 30, 0.9); border-top: 1px solid var(--primary-cyan);
            padding: 12px; display: flex; justify-content: space-between; align-items: center; z-index: 25;
        }
        .bar-left { font-family: 'Orbitron'; font-size: 11px; color: var(--text-secondary); }
        .bar-controls { display: flex; gap: 10px; }
        .icon-btn {
            background: transparent; border: none; color: var(--primary-cyan); cursor: pointer; font-size: 18px;
            transition: 0.2s;
        }
        .icon-btn:hover { color: #fff; text-shadow: 0 0 10px var(--primary-cyan); transform: scale(1.1); }
        .mp3-action-btn {
            background: rgba(255, 0, 0, 0.1); border: 1px solid #ff3333; color: #ff3333;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron'; font-size: 10px;
            text-transform: uppercase; display: none;
        }
        .mp3-action-btn.show { display: block; }
        .mp3-action-btn:hover { background: #ff0000; color: #fff; }

        /* Scanner Overlay */
        .scanner-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 5, 10, 0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(15px);
        }
        .scanner-box {
            background: var(--bg-panel); border: 2px solid var(--primary-cyan);
            padding: 30px; width: 600px; border-radius: 10px; box-shadow: var(--glow-strong); text-align: center;
        }
        .scan-input {
            width: 100%; background: #000; border: 1px solid var(--dark-cyan);
            color: var(--primary-cyan); padding: 12px; margin: 20px 0; font-family: 'Rajdhani'; font-size: 16px;
        }
        .scan-log {
            height: 200px; overflow-y: auto; background: #000; color: var(--primary-cyan);
            font-family: monospace; font-size: 11px; text-align: left; padding: 10px;
            border: 1px solid var(--dark-cyan); margin-top: 15px;
        }
        .scan-log .depth-1 { color: #00ffff; }
        .scan-log .found { color: #ff00ff; font-weight: bold; }
        .scan-log .error { color: #ff0000; }

        /* ZIP Progress */
        .zip-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 3000;
        }
        .zip-box {
            background: var(--bg-panel); border: 2px solid var(--primary-cyan); padding: 30px;
            width: 400px; text-align: center; border-radius: 10px;
        }
        .zip-bar-bg { width: 100%; height: 10px; background: #000; margin: 20px 0; }
        .zip-bar-fill { height: 100%; background: var(--primary-cyan); width: 0%; transition: width 0.3s; }

        /* Download Method Selector */
        .method-selector {
            margin: 15px 0;
            text-align: left;
        }
        
        .method-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            border: 1px solid var(--dark-cyan);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .method-option:hover {
            border-color: var(--primary-cyan);
            background: rgba(0, 255, 255, 0.05);
        }
        
        .method-option input {
            margin-right: 10px;
        }
        
        .method-label {
            flex: 1;
        }
        
        .method-desc {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        @media(max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="cyber-bg" id="cyberBg"></div>
    <div class="grid-overlay"></div>

    <div class="dashboard">
        <header class="header">
            <div class="logo">BEATSTREET <span style="color:var(--primary-cyan)">SELECTOR</span></div>
            <div class="status-bar">
                <div class="status-item"><div class="status-dot"></div> ONLINE</div>
                <div class="status-item"><div class="status-dot" style="background:#ffff00"></div> MANAGER</div>
            </div>
        </header>

        <main class="main-content">
            <!-- Playlist Panel -->
            <section class="panel">
                <div class="panel-title">
                    <span id="playlistTitle">DATA STREAM [0/0]</span>
                    <div>
                        <button class="select-all-btn" id="selectAllBtn">
                            <i class="fas fa-check-double"></i> SELECT ALL
                        </button>
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="playlist-container" id="playlistContainer">
                    <div style="text-align:center; color:var(--text-secondary); padding:30px; opacity:0.5;">NO DATA</div>
                </div>
                <button class="download-zip-btn" id="downloadZipBtn">
                    <i class="fas fa-file-archive"></i> DOWNLOAD SELECTED
                    <small id="selectedCountBadge">(0)</small>
                </button>
            </section>

            <!-- Media Deck Panel -->
            <section class="panel media-deck">
                <div class="deck-input-group">
                    <input type="text" class="cyber-input" id="urlInput" placeholder="ENTER YOUTUBE URL OR MP3 LINK...">
                    <button class="cyber-btn" id="loadBtn">LOAD</button>
                </div>

                <div class="screen-container" id="screenContainer">
                    <div class="corner-decor tl"></div>
                    <div class="corner-decor br"></div>
                    <div class="scanlines"></div>

                    <!-- Mode 1: YouTube -->
                    <div class="screen-content active" id="ytScreen">
                        <div class="yt-placeholder" id="ytPlaceholder">
                            <i class="fab fa-youtube"></i><br>READY TO PLAY
                        </div>
                        <div class="yt-player-container" id="ytPlayerContainer">
                            <!-- Le lecteur sera injecté ici -->
                        </div>
                    </div>

                    <!-- Mode 2: Audio -->
                    <div class="screen-content" id="audioScreen">
                        <div class="audio-player-ui">
                            <div class="audio-info-title" id="audioTitle">NO TRACK</div>
                            <div class="audio-info-path" id="audioPath">WAITING...</div>
                            <div class="audio-wave">
                                <div class="bar" style="animation-delay:0.1s"></div>
                                <div class="bar" style="animation-delay:0.3s"></div>
                                <div class="bar" style="animation-delay:0.5s"></div>
                                <div class="bar" style="animation-delay:0.2s"></div>
                                <div class="bar" style="animation-delay:0.4s"></div>
                            </div>
                        </div>
                        <audio id="html5Audio" controls style="width:100%; position:absolute; bottom:0; opacity:0;"></audio>
                    </div>
                </div>

                <div class="control-bar">
                    <div class="bar-left">
                        <span id="modeIndicator">MODE: YOUTUBE</span>
                        <br>
                        <span id="statusIndicator" style="color:var(--primary-cyan)">READY</span>
                    </div>
                    <div class="bar-controls">
                        <button class="icon-btn" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="icon-btn" id="playPauseBtn"><i class="fas fa-play"></i></button>
                        <button class="icon-btn" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                        <button class="mp3-action-btn" id="mp3ActionBtn"><i class="fas fa-download"></i> GET MP3</button>
                    </div>
                </div>
            </section>

            <!-- Settings -->
            <section class="panel">
                <div class="panel-title">CONTROLS</div>
                <div style="margin-top:auto; text-align:center;">
                    <button class="cyber-btn" onclick="openScanner()" style="width:100%; margin-bottom:10px; border-color:var(--accent-blue); color:var(--accent-blue);">
                        <i class="fas fa-search"></i> DEEP SCAN
                    </button>
                    <button class="cyber-btn" id="clearPlaylistBtn" style="width:100%; background:rgba(255,0,0,0.1); border-color:red; color:red;">
                        <i class="fas fa-trash"></i> CLEAR ALL
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- SCANNER OVERLAY -->
    <div class="scanner-overlay" id="scannerOverlay">
        <div class="scanner-box">
            <h2 style="font-family:'Orbitron'; color:var(--primary-cyan);">RECURSIVE CRAWLER</h2>
            <input type="text" class="scan-input" id="scanInput" value="http://hoj-clan.fr/Music/Skid%20Row/">
            <div class="scan-log" id="scanLog">> System ready...</div>
            <div style="margin-top:15px;">
                <button class="cyber-btn" id="startScanBtn" style="background:rgba(0,255,0,0.1); border-color:#0f0; color:#0f0;">START CRAWL</button>
                <button class="cyber-btn" id="stopScanBtn" style="background:rgba(255,0,0,0.1); border-color:red; color:red; display:none;">
                    <i class="fas fa-stop"></i> STOP SCAN
                </button>
                <button class="cyber-btn" onclick="closeScanner()" style="margin-left:10px;">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- ZIP PROGRESS OVERLAY -->
    <div class="zip-overlay" id="zipOverlay">
        <div class="zip-box">
            <h2 style="font-family:'Orbitron'; color:var(--primary-cyan); margin-bottom:15px;">DOWNLOAD MANAGER</h2>
            
            <div class="method-selector">
                <div class="method-option" onclick="selectMethod('server')">
                    <input type="radio" id="methodServer" name="downloadMethod" checked>
                    <div class="method-label">
                        <strong>SERVER-SIDE DOWNLOAD</strong>
                        <div class="method-desc">Direct download from original server (fastest)</div>
                    </div>
                </div>
                
                <div class="method-option" onclick="selectMethod('proxy')">
                    <input type="radio" id="methodProxy" name="downloadMethod">
                    <div class="method-label">
                        <strong>PROXY DOWNLOAD</strong>
                        <div class="method-desc">Use CORS proxy (works with restrictions)</div>
                    </div>
                </div>
                
                <div class="method-option" onclick="selectMethod('list')">
                    <input type="radio" id="methodList" name="downloadMethod">
                    <div class="method-label">
                        <strong>DOWNLOAD LIST</strong>
                        <div class="method-desc">Generate download links list (manual download)</div>
                    </div>
                </div>
            </div>
            
            <div id="zipStatusText">Select files and choose download method...</div>
            <div class="zip-bar-bg">
                <div class="zip-bar-fill" id="zipProgressBar"></div>
            </div>
            <div id="zipSpeedInfo" style="margin-top:10px; font-size:12px; color:var(--text-secondary);"></div>
            
            <div id="downloadLinks" style="margin-top:15px; text-align:left; max-height:200px; overflow-y:auto; display:none;">
                <!-- Download links will appear here -->
            </div>
            
            <div style="margin-top:20px;">
                <button class="cyber-btn" onclick="startDownload()" id="startDownloadBtn" style="background:rgba(0,255,0,0.1); border-color:#0f0; color:#0f0;">
                    <i class="fas fa-download"></i> START DOWNLOAD
                </button>
                <button class="cyber-btn" onclick="closeZipOverlay()" style="margin-left:10px;">CANCEL</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let playlist = [];
        let selectedUids = new Set();
        let currentIndex = -1;
        let currentMediaItem = null;
        let isSelectAll = false;
        let currentDownloadMethod = 'server'; // 'server', 'proxy', 'list'

        // --- DOM ---
        const screens = {
            yt: document.getElementById('ytScreen'),
            audio: document.getElementById('audioScreen')
        };
        const urlInput = document.getElementById('urlInput');
        const loadBtn = document.getElementById('loadBtn');
        const modeIndicator = document.getElementById('modeIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const playlistTitle = document.getElementById('playlistTitle');
        const selectedCountBadge = document.getElementById('selectedCountBadge');
        const selectAllBtn = document.getElementById('selectAllBtn');
        
        const ytPlaceholder = document.getElementById('ytPlaceholder');
        const ytPlayerContainer = document.getElementById('ytPlayerContainer');
        const audioEl = document.getElementById('html5Audio');
        const audioTitle = document.getElementById('audioTitle');
        const audioPath = document.getElementById('audioPath');
        const mp3ActionBtn = document.getElementById('mp3ActionBtn');

        // --- UTILITY FUNCTIONS ---
        function cleanFileName(filename) {
            if (!filename) return 'track.mp3';
            
            let clean = filename;
            
            // Décoder les URL encodées
            try {
                clean = decodeURIComponent(clean);
            } catch (e) {
                // Nettoyage manuel
                clean = clean.replace(/%20/g, ' ')
                             .replace(/%28/g, '(')
                             .replace(/%29/g, ')')
                             .replace(/%2C/g, ',')
                             .replace(/%27/g, "'")
                             .replace(/%2D/g, '-');
            }
            
            // Extraire juste le nom du fichier
            const lastSlash = clean.lastIndexOf('/');
            if (lastSlash !== -1) {
                clean = clean.substring(lastSlash + 1);
            }
            
            // Supprimer les paramètres
            const queryIndex = clean.indexOf('?');
            if (queryIndex !== -1) {
                clean = clean.substring(0, queryIndex);
            }
            
            // Nettoyer les caractères
            clean = clean.replace(/[<>:"|?*]/g, '_')
                         .replace(/\\/g, '-')
                         .replace(/\//g, '-')
                         .replace(/\.\./g, '.')
                         .replace(/^\s+|\s+$/g, '')
                         .replace(/\s+/g, ' ');
            
            // Assurer l'extension .mp3
            if (!clean.toLowerCase().endsWith('.mp3')) {
                const dotIndex = clean.lastIndexOf('.');
                if (dotIndex !== -1) {
                    clean = clean.substring(0, dotIndex) + '.mp3';
                } else {
                    clean += '.mp3';
                }
            }
            
            // Nom générique si vide
            if (clean.length === 0 || clean.length > 100) {
                const timestamp = Date.now().toString(36);
                clean = `track_${timestamp}.mp3`;
            }
            
            return clean;
        }

        function cleanDisplayName(name) {
            if (!name) return 'Unknown Track';
            
            let clean = name;
            try {
                clean = decodeURIComponent(clean);
            } catch (e) {
                clean = clean.replace(/%20/g, ' ')
                             .replace(/%28/g, '(')
                             .replace(/%29/g, ')')
                             .replace(/%2C/g, ',')
                             .replace(/%27/g, "'");
            }
            
            const lastSlash = clean.lastIndexOf('/');
            if (lastSlash !== -1) {
                clean = clean.substring(lastSlash + 1);
            }
            
            clean = clean.replace(/\.mp3$/i, '');
            return clean;
        }

        // --- DOWNLOAD METHOD SELECTION ---
        function selectMethod(method) {
            currentDownloadMethod = method;
            
            // Mettre à jour les radios
            document.getElementById('methodServer').checked = method === 'server';
            document.getElementById('methodProxy').checked = method === 'proxy';
            document.getElementById('methodList').checked = method === 'list';
            
            // Mettre à jour le texte
            const statusText = document.getElementById('zipStatusText');
            const downloadLinks = document.getElementById('downloadLinks');
            
            if (method === 'list') {
                statusText.textContent = "Will generate download links list";
                downloadLinks.style.display = 'block';
            } else {
                statusText.textContent = `Ready for ${method} download`;
                downloadLinks.style.display = 'none';
            }
        }

        // --- DOWNLOAD MANAGER ---
        class DownloadManager {
            constructor() {
                this.progress = 0;
                this.totalFiles = 0;
                this.processedFiles = 0;
                this.successCount = 0;
                this.failedCount = 0;
                this.startTime = null;
                this.downloadQueue = [];
                this.isDownloading = false;
            }

            // Méthode 1: Téléchargement direct depuis le serveur
            async downloadDirect(url) {
                try {
                    // Créer un lien caché et le cliquer
                    return new Promise((resolve, reject) => {
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = '';
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        
                        // Essayer de déclencher le téléchargement
                        setTimeout(() => {
                            try {
                                link.click();
                                resolve(true);
                            } catch (e) {
                                reject(e);
                            } finally {
                                document.body.removeChild(link);
                            }
                        }, 100);
                    });
                } catch (error) {
                    throw error;
                }
            }

            // Méthode 2: Utiliser un proxy
            async downloadWithProxy(url) {
                const proxies = [
                    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                    `https://corsproxy.io/?${encodeURIComponent(url)}`,
                    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
                ];

                for (const proxyUrl of proxies) {
                    try {
                        const response = await fetch(proxyUrl, {
                            signal: AbortSignal.timeout(10000)
                        });
                        
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const blob = await response.blob();
                        if (blob.size > 0) {
                            return blob;
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                throw new Error("All proxies failed");
            }

            // Méthode 3: Générer des liens de téléchargement
            generateDownloadLink(url, filename) {
                return {
                    url: url,
                    filename: filename,
                    link: `<a href="${url}" download="${filename}" target="_blank">${filename}</a>`
                };
            }

            // Téléchargement en batch
            async downloadBatch(items, method) {
                this.startTime = Date.now();
                this.totalFiles = items.length;
                this.processedFiles = 0;
                this.successCount = 0;
                this.failedCount = 0;
                this.isDownloading = true;

                const results = {
                    success: [],
                    failed: [],
                    links: []
                };

                if (method === 'list') {
                    // Générer seulement la liste de liens
                    for (const item of items) {
                        const cleanName = cleanFileName(item.name);
                        const link = this.generateDownloadLink(item.url, cleanName);
                        results.links.push(link);
                        this.processedFiles++;
                        this.updateProgress();
                    }
                    return results;
                }

                // Téléchargements réels
                for (const item of items) {
                    try {
                        const cleanName = cleanFileName(item.name);
                        
                        if (method === 'server') {
                            await this.downloadDirect(item.url);
                            results.success.push({ name: cleanName, url: item.url });
                            this.successCount++;
                        } else if (method === 'proxy') {
                            const blob = await this.downloadWithProxy(item.url);
                            if (blob) {
                                // Créer un lien pour télécharger le blob
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = cleanName;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                // Libérer la mémoire
                                setTimeout(() => URL.revokeObjectURL(link.href), 1000);
                                
                                results.success.push({ name: cleanName, url: item.url });
                                this.successCount++;
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to download ${item.name}:`, error);
                        results.failed.push({ name: item.name, error: error.message });
                        this.failedCount++;
                    } finally {
                        this.processedFiles++;
                        this.updateProgress();
                        
                        // Petite pause pour éviter de surcharger
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                this.isDownloading = false;
                return results;
            }

            updateProgress() {
                this.progress = (this.processedFiles / this.totalFiles) * 100;
                
                const progressBar = document.getElementById('zipProgressBar');
                const statusText = document.getElementById('zipStatusText');
                const speedInfo = document.getElementById('zipSpeedInfo');
                
                if (progressBar) progressBar.style.width = this.progress + '%';
                if (statusText) {
                    statusText.textContent = `Processed ${this.processedFiles}/${this.totalFiles} files`;
                }
                
                if (this.startTime && speedInfo) {
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    if (elapsed > 0) {
                        const speed = this.processedFiles / elapsed;
                        speedInfo.textContent = `Speed: ${speed.toFixed(1)} files/sec | Success: ${this.successCount}`;
                    }
                }
            }

            getProgress() {
                return this.progress;
            }
        }

        // --- ZIP OVERLAY FUNCTIONS ---
        function openZipOverlay() {
            if (selectedUids.size === 0) {
                alert("Please select songs first by checking the boxes.");
                return;
            }
            
            const selectedItems = playlist.filter(item => selectedUids.has(item.uid));
            const audioItems = selectedItems.filter(item => item.type === 'audio');
            
            if (audioItems.length === 0) {
                alert("No audio files selected for download.");
                return;
            }

            // Réinitialiser l'interface
            document.getElementById('zipProgressBar').style.width = '0%';
            document.getElementById('zipStatusText').textContent = `Ready to download ${audioItems.length} files`;
            document.getElementById('zipSpeedInfo').textContent = `Selected: ${audioItems.length} files | Choose method`;
            document.getElementById('downloadLinks').innerHTML = '';
            document.getElementById('downloadLinks').style.display = 'none';
            
            // Afficher l'overlay
            document.getElementById('zipOverlay').style.display = 'flex';
        }

        function closeZipOverlay() {
            document.getElementById('zipOverlay').style.display = 'none';
        }

        async function startDownload() {
            const selectedItems = playlist.filter(item => selectedUids.has(item.uid));
            const audioItems = selectedItems.filter(item => item.type === 'audio');
            
            const downloadManager = new DownloadManager();
            const startDownloadBtn = document.getElementById('startDownloadBtn');
            const downloadLinks = document.getElementById('downloadLinks');
            
            // Désactiver le bouton pendant le téléchargement
            startDownloadBtn.disabled = true;
            startDownloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> DOWNLOADING...';
            
            try {
                const results = await downloadManager.downloadBatch(audioItems, currentDownloadMethod);
                
                if (currentDownloadMethod === 'list') {
                    // Afficher les liens
                    let linksHTML = '<h4>DOWNLOAD LINKS:</h4>';
                    results.links.forEach((link, index) => {
                        linksHTML += `
                            <div style="margin: 5px 0; padding: 8px; border: 1px solid var(--dark-cyan); border-radius: 3px;">
                                <strong>${index + 1}.</strong> ${link.filename}<br>
                                <a href="${link.url}" download="${link.filename}" target="_blank" 
                                   style="color: var(--primary-cyan); font-size: 11px;">
                                   <i class="fas fa-download"></i> Download
                                </a> |
                                <a href="${link.url}" target="_blank" 
                                   style="color: var(--accent-blue); font-size: 11px;">
                                   <i class="fas fa-external-link-alt"></i> Open
                                </a>
                            </div>
                        `;
                    });
                    
                    downloadLinks.innerHTML = linksHTML;
                    downloadLinks.style.display = 'block';
                    
                    // Ajouter un bouton pour tout télécharger
                    const bulkHTML = `
                        <div style="margin-top: 15px; padding: 10px; background: rgba(0,255,255,0.1); border-radius: 5px;">
                            <strong>BULK DOWNLOAD:</strong><br>
                            <div style="font-size: 11px; margin: 5px 0;">
                                Copy all links and use a download manager like <a href="https://github.com/yt-dlp/yt-dlp" target="_blank" style="color: var(--primary-cyan);">yt-dlp</a>:
                            </div>
                            <textarea id="bulkLinks" style="width: 100%; height: 60px; background: #000; color: var(--primary-cyan); border: 1px solid var(--dark-cyan); padding: 5px; font-size: 10px; font-family: monospace; margin: 5px 0;">${results.links.map(l => l.url).join('\n')}</textarea>
                            <button onclick="copyBulkLinks()" style="background: var(--primary-cyan); color: #000; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                                <i class="fas fa-copy"></i> Copy Links
                            </button>
                        </div>
                    `;
                    
                    downloadLinks.innerHTML += bulkHTML;
                    
                    document.getElementById('zipStatusText').textContent = `Generated ${results.links.length} download links`;
                    
                } else {
                    // Téléchargement direct ou proxy
                    const elapsed = (Date.now() - downloadManager.startTime) / 1000;
                    const speed = downloadManager.successCount / elapsed;
                    
                    document.getElementById('zipSpeedInfo').textContent = 
                        `Completed in ${elapsed.toFixed(1)}s | Speed: ${speed.toFixed(1)} files/sec | Success: ${downloadManager.successCount}/${audioItems.length}`;
                    
                    if (downloadManager.successCount > 0) {
                        document.getElementById('zipStatusText').textContent = 
                            `✅ Successfully downloaded ${downloadManager.successCount} files!`;
                        
                        // Afficher les échecs
                        if (downloadManager.failedCount > 0) {
                            setTimeout(() => {
                                alert(`Download complete!\n\nSuccess: ${downloadManager.successCount} files\nFailed: ${downloadManager.failedCount} files\n\nFailed files may require manual download.`);
                            }, 1000);
                        }
                    } else {
                        document.getElementById('zipStatusText').textContent = 
                            `❌ Download failed. Try another method or download manually.`;
                    }
                }
                
            } catch (error) {
                console.error("Download error:", error);
                document.getElementById('zipStatusText').textContent = `Error: ${error.message}`;
            } finally {
                // Réactiver le bouton
                startDownloadBtn.disabled = false;
                startDownloadBtn.innerHTML = '<i class="fas fa-download"></i> START DOWNLOAD';
            }
        }

        function copyBulkLinks() {
            const textarea = document.getElementById('bulkLinks');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // Pour mobile
            document.execCommand('copy');
            
            // Feedback visuel
            const originalText = textarea.placeholder;
            textarea.placeholder = "Links copied to clipboard!";
            setTimeout(() => {
                textarea.placeholder = originalText;
            }, 2000);
        }

        // --- YOUTUBE PLAYER SIMPLE ---
        class SimpleYouTubePlayer {
            async playVideo(videoId, autoplay = false) {
                ytPlaceholder.style.display = 'flex';
                ytPlaceholder.innerHTML = `<i class="fab fa-youtube"></i><br>LOADING...`;
                
                try {
                    ytPlayerContainer.innerHTML = '';
                    
                    const iframe = document.createElement('iframe');
                    iframe.id = 'ytPlayer';
                    iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=${autoplay ? 1 : 0}`;
                    iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                    iframe.setAttribute('allowfullscreen', '');
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.border = 'none';
                    
                    ytPlayerContainer.appendChild(iframe);
                    
                    // Attendre le chargement
                    await new Promise((resolve) => {
                        iframe.onload = () => {
                            setTimeout(() => {
                                ytPlaceholder.style.display = 'none';
                                resolve();
                            }, 500);
                        };
                        setTimeout(resolve, 3000);
                    });
                    
                    statusIndicator.textContent = autoplay ? "PLAYING" : "READY";
                    const playBtnIcon = document.querySelector('#playPauseBtn i');
                    playBtnIcon.className = autoplay ? 'fas fa-pause' : 'fas fa-play';
                    
                    return true;
                    
                } catch (error) {
                    this.showFallback(videoId);
                    return false;
                }
            }

            showFallback(videoId) {
                ytPlayerContainer.innerHTML = '';
                ytPlaceholder.style.display = 'flex';
                ytPlaceholder.innerHTML = `
                    <div style="text-align:center;">
                        <i class="fab fa-youtube" style="font-size:48px; color:#ff0000;"></i>
                        <div style="margin:15px 0;">
                            <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" 
                               style="color:var(--primary-cyan); text-decoration:none; padding:10px 20px; border:2px solid var(--primary-cyan); border-radius:5px; display:inline-block;">
                               <i class="fas fa-external-link-alt"></i> WATCH ON YOUTUBE
                            </a>
                        </div>
                    </div>
                `;
                statusIndicator.textContent = "EMBEDDING DISABLED";
            }

            stop() {
                ytPlayerContainer.innerHTML = '';
                ytPlaceholder.style.display = 'flex';
                ytPlaceholder.innerHTML = `<i class="fab fa-youtube"></i><br>READY TO PLAY`;
            }
        }

        const youtubePlayer = new SimpleYouTubePlayer();

        // --- PLAYBACK LOGIC ---
        function switchScreen(type) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (type === 'youtube') {
                screens.yt.classList.add('active');
                modeIndicator.textContent = "MODE: YOUTUBE";
                mp3ActionBtn.classList.add('show');
            } else if (type === 'audio') {
                screens.audio.classList.add('active');
                modeIndicator.textContent = "MODE: AUDIO STREAM";
                mp3ActionBtn.classList.remove('show');
            }
        }

        function playMedia(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index;
            currentMediaItem = playlist[index];

            renderPlaylist();

            if (currentMediaItem.type === 'youtube') {
                switchScreen('youtube');
                const id = extractYTId(currentMediaItem.url);
                
                if(id) {
                    youtubePlayer.playVideo(id, false);
                    
                    mp3ActionBtn.onclick = () => {
                        window.open(`https://youtubemultidownloader.org/en/?url=${encodeURIComponent(currentMediaItem.url)}`, '_blank');
                    };
                } else {
                    statusIndicator.textContent = "ERROR: Invalid YouTube URL";
                    ytPlaceholder.style.display = 'flex';
                    ytPlaceholder.innerHTML = `<i class="fab fa-youtube"></i><br>INVALID URL`;
                }

            } else if (currentMediaItem.type === 'audio') {
                switchScreen('audio');
                audioEl.src = currentMediaItem.url;
                audioEl.play();
                audioTitle.textContent = cleanDisplayName(currentMediaItem.name);
                
                if(currentMediaItem.path) {
                    audioPath.textContent = cleanDisplayName(currentMediaItem.path);
                } else {
                    audioPath.textContent = "/";
                }
                statusIndicator.textContent = "PLAYING";
                
                const playBtnIcon = document.querySelector('#playPauseBtn i');
                playBtnIcon.className = 'fas fa-pause';
            }
        }

        loadBtn.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (!url) return;

            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = extractYTId(url);
                if (videoId) {
                    const displayName = cleanDisplayName(url.split('/').pop() || `YouTube: ${videoId}`);
                    addToPlaylist(url, displayName, 'youtube', 'YouTube Root');
                    playMedia(playlist.length - 1);
                } else {
                    alert("Invalid YouTube URL");
                }
            } else if (url.toLowerCase().endsWith('.mp3')) {
                const displayName = cleanDisplayName(url.split('/').pop());
                addToPlaylist(url, displayName, 'audio', '/');
                playMedia(playlist.length - 1);
            } else {
                document.getElementById('scanInput').value = url;
                openScanner();
            }
        });

        // --- CONTROLS ---
        const playBtn = document.getElementById('playPauseBtn');
        playBtn.addEventListener('click', () => {
            const icon = playBtn.querySelector('i');
            if (currentMediaItem && currentMediaItem.type === 'youtube') {
                const id = extractYTId(currentMediaItem.url);
                if (id) {
                    if (icon.className.includes('fa-play')) {
                        youtubePlayer.playVideo(id, true);
                    } else {
                        youtubePlayer.playVideo(id, false);
                    }
                }
            } else if (currentMediaItem && currentMediaItem.type === 'audio') {
                if(audioEl.paused) { 
                    audioEl.play(); 
                    icon.className='fas fa-pause'; 
                    statusIndicator.textContent = "PLAYING";
                }
                else { 
                    audioEl.pause(); 
                    icon.className='fas fa-play'; 
                    statusIndicator.textContent = "PAUSED";
                }
            }
        });

        document.getElementById('nextBtn').onclick = () => playMedia((currentIndex + 1) % playlist.length);
        document.getElementById('prevBtn').onclick = () => playMedia((currentIndex - 1 + playlist.length) % playlist.length);
        
        document.getElementById('clearPlaylistBtn').onclick = () => {
            playlist = [];
            selectedUids.clear();
            currentIndex = -1;
            isSelectAll = false;
            selectAllBtn.innerHTML = '<i class="fas fa-check-double"></i> SELECT ALL';
            
            youtubePlayer.stop();
            audioEl.pause();
            renderPlaylist();
        };

        // --- BOUTON SELECT ALL ---
        selectAllBtn.addEventListener('click', () => {
            if (playlist.length === 0) return;
            
            isSelectAll = !isSelectAll;
            
            if (isSelectAll) {
                selectedUids.clear();
                playlist.forEach(item => {
                    selectedUids.add(item.uid);
                });
                selectAllBtn.innerHTML = '<i class="fas fa-times"></i> DESELECT ALL';
            } else {
                selectedUids.clear();
                selectAllBtn.innerHTML = '<i class="fas fa-check-double"></i> SELECT ALL';
            }
            
            renderPlaylist();
        });

        // --- PLAYLIST MANAGEMENT ---
        function addToPlaylist(url, name, type, path) {
            const uid = Date.now().toString(36) + Math.random().toString(36).substr(2);
            playlist.push({ url, name, type, path, uid });
            renderPlaylist();
        }

        function toggleSelection(uid) {
            if (selectedUids.has(uid)) {
                selectedUids.delete(uid);
            } else {
                selectedUids.add(uid);
            }
            
            updateSelectAllState();
            renderPlaylist();
        }

        function updateSelectAllState() {
            const allSelected = playlist.length > 0 && playlist.every(item => selectedUids.has(item.uid));
            
            if (allSelected) {
                isSelectAll = true;
                selectAllBtn.innerHTML = '<i class="fas fa-times"></i> DESELECT ALL';
            } else {
                isSelectAll = false;
                selectAllBtn.innerHTML = '<i class="fas fa-check-double"></i> SELECT ALL';
            }
        }

        function deleteTrack(uid, event) {
            if(event) event.stopPropagation();
            
            playlist = playlist.filter(item => item.uid !== uid);
            selectedUids.delete(uid);
            
            if(currentMediaItem && currentMediaItem.uid === uid) {
                currentMediaItem = null;
                currentIndex = -1;
                
                youtubePlayer.stop();
                audioEl.pause();
                
                const playBtnIcon = document.querySelector('#playPauseBtn i');
                playBtnIcon.className = 'fas fa-play';
                statusIndicator.textContent = "READY";
            }
            
            updateSelectAllState();
            renderPlaylist();
        }

        function renderPlaylist() {
            const container = document.getElementById('playlistContainer');
            container.innerHTML = '';
            
            if(playlist.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:30px;">NO DATA</div>';
                playlistTitle.textContent = "DATA STREAM [0/0]";
                selectedCountBadge.textContent = "(0)";
                return;
            }

            playlist.forEach((item, idx) => {
                const div = document.createElement('div');
                const isSelected = selectedUids.has(item.uid);
                div.className = `playlist-item ${idx === currentIndex ? 'active' : ''}`;
                
                let icon = '';
                if(item.type === 'youtube') icon = '<i class="fab fa-youtube"></i>';
                else if(item.type === 'audio') icon = '<i class="fas fa-music"></i>';

                let pathDisplay = '';
                if (item.path && item.path !== '/' && item.path !== 'YouTube Root') {
                    const parts = cleanDisplayName(item.path).split('/').filter(p => p);
                    pathDisplay = parts.join(' <i class="fas fa-chevron-right" style="font-size:8px; margin:0 2px;"></i> ');
                }

                div.innerHTML = `
                    <div class="cyber-check ${isSelected ? 'checked' : ''}" onclick="toggleSelection('${item.uid}')"></div>
                    <div class="track-info-wrapper">
                        <div class="track-path">${pathDisplay}</div>
                        <div class="track-name">${icon} ${cleanDisplayName(item.name)}</div>
                    </div>
                    <div class="delete-btn" onclick="deleteTrack('${item.uid}', event)">
                        <i class="fas fa-times"></i>
                    </div>
                `;
                
                div.addEventListener('click', (e) => {
                    if(!e.target.classList.contains('cyber-check') && !e.target.closest('.delete-btn')) {
                        playMedia(idx);
                    }
                });
                
                container.appendChild(div);
            });

            playlistTitle.textContent = `DATA STREAM [${selectedUids.size}/${playlist.length}]`;
            selectedCountBadge.textContent = `(${selectedUids.size})`;
        }

        // --- MODIFIER LE BOUTON ZIP POUR OUVRIR L'OVERLAY ---
        document.getElementById('downloadZipBtn').addEventListener('click', openZipOverlay);

        function extractYTId(url) {
            try {
                const patterns = [
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i,
                    /youtube\.com\/watch\?v=([^&]{11})/,
                    /youtu\.be\/([^?]{11})/,
                    /youtube\.com\/embed\/([^?]{11})/
                ];
                
                for (const pattern of patterns) {
                    const match = url.match(pattern);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
                
                return null;
            } catch(e) {
                return null;
            }
        }

        // --- SCANNER ---
        function openScanner() { 
            document.getElementById('scannerOverlay').style.display = 'flex'; 
        }
        
        function closeScanner() { 
            document.getElementById('scannerOverlay').style.display = 'none'; 
        }

        const PROXIES = [
            (u) => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`
        ];

        async function fetchContent(url) {
            for (let i = 0; i < PROXIES.length; i++) {
                try {
                    const proxyUrl = PROXIES[i](url);
                    const res = await fetch(proxyUrl);
                    if(!res.ok) throw new Error(res.status);
                    let content = proxyUrl.includes('allorigins') ? (await res.json()).contents : await res.text();
                    return content;
                } catch(e) { continue; }
            }
            throw new Error("Proxy Access Denied");
        }

        let isScanning = false;

        document.getElementById('startScanBtn').addEventListener('click', async () => {
            const startUrl = document.getElementById('scanInput').value.trim();
            if(!startUrl) return;

            isScanning = true;
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            
            const log = document.getElementById('scanLog');
            log.innerHTML = "";

            function l(msg, type='') {
                const div = document.createElement('div');
                div.textContent = msg;
                if(type==='found') div.className='found';
                if(type==='error') div.className='error';
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            }

            l("Starting deep recursive scan...");

            const rootUrlObj = new URL(startUrl);
            const rootUrl = rootUrlObj.href.endsWith('/') ? rootUrlObj.href : rootUrlObj.href + '/';

            const queue = [{ url: startUrl, depth: 0 }];
            const visited = new Set();
            const maxDepth = 20;

            while(queue.length > 0 && isScanning) {
                const { url, depth } = queue.shift();
                
                if(visited.has(url)) continue;
                visited.add(url);

                let relativePath = url.replace(rootUrlObj.origin, '');
                if(relativePath.startsWith('/')) relativePath = relativePath.substring(1);

                const depthClass = depth < 2 ? 'depth-1' : '';
                l(`[DEPTH ${depth}] ${cleanDisplayName(relativePath.replace(/\/$/, ''))}`, depthClass);

                try {
                    const html = await fetchContent(url);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = Array.from(doc.querySelectorAll('a'));

                    links.forEach(link => {
                        const href = link.getAttribute('href');
                        if(!href) return;

                        try {
                            if(href.startsWith('../') || href.includes('?')) return;
                            if(href.startsWith('#')) return;

                            const absUrl = new URL(href, url).href;
                            
                            if(!absUrl.includes(rootUrlObj.origin)) return;

                            if(absUrl.toLowerCase().endsWith('.mp3')) {
                                const fileName = cleanDisplayName(absUrl.split('/').pop());
                                const filePath = cleanDisplayName(absUrl.replace(rootUrlObj.origin, ''));
                                
                                addToPlaylist(absUrl, fileName, 'audio', filePath);
                                l(`  → FOUND: ${fileName}`, 'found');
                            } else if (absUrl.endsWith('/') && depth < maxDepth) {
                                if(!visited.has(absUrl)) queue.push({ url: absUrl, depth: depth + 1 });
                            }
                        } catch(e){}
                    });
                } catch(e) {
                    l(`ERROR: ${e.message}`, 'error');
                }
                await new Promise(r => setTimeout(r, 200));
            }
            
            if(!isScanning) {
                l("SCAN STOPPED BY USER.");
            } else {
                l("SCAN COMPLETE.");
                document.getElementById('startScanBtn').style.display = 'inline-block';
                document.getElementById('stopScanBtn').style.display = 'none';
                isScanning = false;
            }
        });

        document.getElementById('stopScanBtn').addEventListener('click', () => {
            isScanning = false;
        });

        // Initialisation
        window.addEventListener('DOMContentLoaded', () => {
            urlInput.value = 'https://www.youtube.com/watch?v=dQw4w9WgXcQ';
            statusIndicator.textContent = "READY";
            
            // Sélectionner la méthode par défaut
            selectMethod('server');
        });

        // Exposer les fonctions globales
        window.openScanner = openScanner;
        window.closeScanner = closeScanner;
        window.toggleSelection = toggleSelection;
        window.deleteTrack = deleteTrack;
        window.selectMethod = selectMethod;
        window.startDownload = startDownload;
        window.closeZipOverlay = closeZipOverlay;
        window.copyBulkLinks = copyBulkLinks;
        window.openZipOverlay = openZipOverlay;
    </script>
</body>
</html>
