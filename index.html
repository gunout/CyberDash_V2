<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEATSTREET CYBERDASH - Proxy V3 & Direct Mode</title>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary-cyan: #00ffff;
            --neon-blue: #00f3ff;
            --dark-cyan: #0088aa;
            --accent-blue: #0099ff;
            --bg-dark: #020205;
            --bg-panel: rgba(5, 15, 30, 0.9);
            --text-primary: #e0faff;
            --text-secondary: #00cccc;
            --danger-red: #ff3333;
            --success-green: #00ff66;
            --warning-orange: #ff9900;
            --purple: #ff00ff;
            --glow-cyan: 0 0 10px rgba(0, 255, 255, 0.6), 0 0 20px rgba(0, 255, 255, 0.4);
            --glow-strong: 0 0 15px var(--neon-blue), 0 0 30px var(--primary-cyan);
        }

        body {
            background: linear-gradient(135deg, #020205 0%, #050a15 50%, #0a0f20 100%);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .cyber-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index:1; }
        .particle {
            position: absolute; width: 2px; height: 2px; background: var(--primary-cyan);
            border-radius: 50%; box-shadow: var(--glow-cyan); animation: float 20s infinite linear;
        }
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }
        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0,255,255, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(0,255,255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none; z-index: 2;
        }

        .dashboard {
            position: relative; z-index: 10;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            padding: 20px;
        }

        .header {
            background: rgba(0, 20, 30, 0.7); border: 1px solid var(--primary-cyan);
            border-radius: 10px; padding: 15px 25px; backdrop-filter: blur(15px);
            box-shadow: var(--glow-cyan); display: flex; justify-content: space-between; align-items: center;
        }
        .logo {
            font-family: 'Orbitron', monospace; font-size: 24px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, var(--primary-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .status-bar { display: flex; gap: 15px; font-family: 'Orbitron', monospace; font-size: 12px; }
        .status-item { color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: var(--primary-cyan); border-radius: 50%; box-shadow: var(--glow-cyan); }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr 250px;
            gap: 20px;
            min-height: 0; 
        }

        .panel {
            background: var(--bg-panel); border: 1px solid var(--dark-cyan);
            border-radius: 10px; padding: 15px; backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .panel-title {
            font-family: 'Orbitron', monospace; font-size: 14px; font-weight: 700;
            color: var(--primary-cyan); margin-bottom: 15px; border-bottom: 1px solid var(--dark-cyan);
            padding-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .select-all-btn {
            background: transparent; border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan); padding: 4px 10px; border-radius: 4px;
            font-family: 'Rajdhani', sans-serif; font-size: 11px; cursor: pointer;
            transition: all 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .select-all-btn:hover { background: rgba(0, 255, 255, 0.1); box-shadow: 0 0 10px var(--primary-cyan); }
        .select-all-btn i { font-size: 10px; }

        .playlist-container {
            flex: 1; overflow-y: auto; overflow-x: hidden; margin-bottom: 15px; padding-right: 5px;
        }
        .playlist-container::-webkit-scrollbar { width: 10px; }
        .playlist-container::-webkit-scrollbar-track { background: rgba(0, 20, 40, 0.6); border-radius: 5px; }
        .playlist-container::-webkit-scrollbar-thumb { background: var(--dark-cyan); border-radius: 5px; border: 1px solid rgba(0,0,0,0.2); }
        .playlist-container::-webkit-scrollbar-thumb:hover { background: var(--primary-cyan); box-shadow: 0 0 10px var(--primary-cyan); }

        .playlist-item {
            background: rgba(0,255,255, 0.03); border-left: 3px solid var(--dark-cyan);
            padding: 10px; margin-bottom: 5px; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 10px; position: relative;
        }
        
        .cyber-check {
            width: 18px; height: 18px; border: 1px solid var(--primary-cyan);
            background: rgba(0, 0, 0, 0.5); cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; flex-shrink: 0;
        }
        .cyber-check:hover { background: rgba(0, 255, 255, 0.1); box-shadow: 0 0 10px var(--primary-cyan); }
        .cyber-check.checked { background: var(--primary-cyan); box-shadow: 0 0 10px var(--primary-cyan); }
        .cyber-check.checked::after { content: '✓'; color: #000; font-weight: bold; font-size: 12px; }

        .delete-btn {
            opacity: 0; background: var(--danger-red); color: #fff; width: 24px; height: 24px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; position: absolute; right: -10px;
        }
        .playlist-item:hover .delete-btn { opacity: 1; right: 10px; }
        .delete-btn:hover { transform: scale(1.2); box-shadow: 0 0 10px var(--danger-red); }

        .playlist-item:hover {
            background: rgba(0,255,255, 0.1); border-left-color: var(--primary-cyan);
            transform: translateX(2px);
        }
        .playlist-item.active { background: rgba(0,255,255, 0.15); border-left-color: #fff; box-shadow: 0 0 10px rgba(0,255,255,0.1); }

        .track-info-wrapper { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .track-path {
            font-size: 11px; color: var(--text-secondary); opacity: 0.8;
            font-family: monospace; display: flex; align-items: center; gap: 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .track-path i { color: var(--primary-cyan); font-size: 10px; }
        .track-name {
            font-size: 13px; font-weight: 600; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; align-items: center; gap: 8px;
        }

        .action-btn {
            border: none; color: #000; padding: 10px; border-radius: 5px;
            font-family: 'Orbitron'; font-weight: 700; cursor: pointer; text-transform: uppercase;
            font-size: 12px; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0;
            margin-bottom: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .download-zip-btn { background: linear-gradient(45deg, var(--primary-cyan), var(--accent-blue)); box-shadow: var(--glow-cyan); }
        .download-zip-btn:hover { transform: translateY(-2px); box-shadow: var(--glow-strong); }
        .download-zip-btn small { font-size: 10px; opacity: 0.8; }
        .test-download-btn { background: linear-gradient(45deg, var(--warning-orange), #ff6600); box-shadow: 0 0 10px rgba(255, 153, 0, 0.6); }
        .test-download-btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(255, 153, 0, 0.8); }
        .download-all-btn { background: linear-gradient(45deg, var(--purple), #cc00cc); box-shadow: 0 0 10px rgba(255, 0, 255, 0.6); }
        .download-all-btn:hover { transform: translateY(-2px); box-shadow: 0 0 15px rgba(255, 0, 255, 0.8); }

        .media-deck { flex: 1; display: flex; flex-direction: column; }
        .deck-input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .cyber-input {
            flex:1; background: rgba(0, 10, 20, 0.9); border: 1px solid var(--dark-cyan);
            border-radius: 4px; padding: 10px; color: var(--primary-cyan);
            font-family: 'Rajdhani', sans-serif; font-size: 14px; outline: none;
        }
        .cyber-btn {
            background: rgba(0,255,255, 0.1); border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan); padding: 0 20px; border-radius: 4px; cursor: pointer;
            font-family: 'Orbitron', monospace; font-weight: 700; text-transform: uppercase;
            transition: all 0.3s;
        }
        .cyber-btn:hover { background: var(--primary-cyan); color: #000; box-shadow: var(--glow-cyan); }

        .screen-container {
            flex: 1; background: #000; border: 1px solid var(--dark-cyan); border-radius: 8px;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }
        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 20;
        }
        .corner-decor { position: absolute; width: 15px; height: 15px; border: 2px solid var(--primary-cyan); opacity: 0.5; z-index: 21; }
        .tl { top: 10px; left: 10px; border-right: none; border-bottom: none; }
        .br { bottom: 10px; right: 10px; border-left: none; border-top: none; }

        .screen-content { flex: 1; position: relative; display: none; justify-content: center; align-items: center; }
        .screen-content.active { display: flex; }

        .yt-placeholder { 
            position: absolute; text-align: center; color: var(--dark-cyan); z-index: 2;
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; background: rgba(0,0,0,0.9);
        }
        .yt-placeholder i { font-size: 50px; margin-bottom: 15px; opacity: 0.3; }
        
        .yt-player-container { width: 100%; height: 100%; position: relative; z-index: 10; }
        .yt-player-container iframe { width: 100%; height: 100%; border: none; }

        .audio-player-ui {
            width: 100%; padding: 20px; text-align: center; color: var(--primary-cyan);
            display: flex; flex-direction: column; justify-content: center; gap: 20px; height: 100%;
        }
        .audio-info-title { font-family: 'Orbitron'; font-size: 18px; text-shadow: 0 0 10px var(--primary-cyan); word-break: break-all; }
        .audio-info-path { font-family: 'Rajdhani'; font-size: 14px; opacity: 0.7; }
        
        .audio-wave { height: 100px; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .bar { width: 10px; background: var(--primary-cyan); animation: wave 1s infinite ease-in-out; }
        @keyframes wave { 0%, 100% { height: 10px; opacity: 0.5; } 50% { height: 80px; opacity: 1; box-shadow: 0 0 10px var(--primary-cyan); } }
        
        .control-bar {
            background: rgba(0, 20, 30, 0.9); border-top: 1px solid var(--primary-cyan);
            padding: 12px; display: flex; justify-content: space-between; align-items: center; z-index: 25;
        }
        .bar-left { font-family: 'Orbitron'; font-size: 11px; color: var(--text-secondary); }
        .bar-controls { display: flex; gap: 10px; }
        .icon-btn {
            background: transparent; border: none; color: var(--primary-cyan); cursor: pointer; font-size: 18px;
            transition: 0.2s;
        }
        .icon-btn:hover { color: #fff; text-shadow: 0 0 10px var(--primary-cyan); transform: scale(1.1); }
        .mp3-action-btn {
            background: rgba(255, 0, 0, 0.1); border: 1px solid #ff3333; color: #ff3333;
            padding: 5px 12px; border-radius: 4px; cursor: pointer; font-family: 'Orbitron'; font-size: 10px;
            text-transform: uppercase; display: none;
        }
        .mp3-action-btn.show { display: block; }
        .mp3-action-btn:hover { background: #ff0000; color: #fff; }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 3000;
        }
        .overlay-box {
            background: var(--bg-panel); border: 2px solid var(--primary-cyan); padding: 30px;
            width: 600px; text-align: center; border-radius: 10px; position: relative;
        }
        .scan-log {
            height: 200px; overflow-y: auto; background: #000; color: var(--primary-cyan);
            font-family: monospace; font-size: 11px; text-align: left; padding: 10px;
            border: 1px solid var(--dark-cyan); margin-top: 15px;
        }
        .scan-log .found { color: #ff00ff; font-weight: bold; }
        .scan-log .error { color: #ff0000; }
        .scan-log .warning { color: #ffff00; }
        .scan-log .info { color: #00ffff; }

        /* Toggle Switch */
        .toggle-wrapper {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .toggle-checkbox { display: none; }
        .toggle-slider {
            width: 34px; height: 18px; background-color: #333; border-radius: 10px; position: relative; transition: 0.3s;
            border: 1px solid var(--dark-cyan);
        }
        .toggle-slider:before {
            content: ""; position: absolute; height: 10px; width: 10px; left: 4px; bottom: 3px;
            background-color: white; border-radius: 50%; transition: 0.3s;
        }
        .toggle-checkbox:checked + .toggle-slider { background-color: var(--success-green); }
        .toggle-checkbox:checked + .toggle-slider:before { transform: translateX(16px); }

        .zip-bar-bg { width: 100%; height: 10px; background: #000; margin: 20px 0; }
        .zip-bar-fill { height: 100%; background: var(--primary-cyan); width: 0%; transition: width 0.1s linear; }

        .toast-container {
            position: fixed; bottom: 30px; right: 30px; z-index: 5000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: rgba(0, 10, 20, 0.95); border: 1px solid var(--primary-cyan);
            color: var(--primary-cyan); padding: 15px 20px; border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3); display: flex; align-items: center; gap: 10px;
            font-family: 'Orbitron', monospace; font-size: 12px; animation: slideIn 0.3s ease-out forwards;
            max-width: 400px;
        }
        .toast.success { border-color: var(--success-green); color: var(--success-green); }
        .toast.error { border-color: var(--danger-red); color: var(--danger-red); }
        .toast.warning { border-color: var(--warning-orange); color: var(--warning-orange); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { to { transform: translateX(100%); opacity: 0; } }

        @media(max-width: 900px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="cyber-bg" id="cyberBg"></div>
    <div class="grid-overlay"></div>
    <div class="toast-container" id="toastContainer"></div>

    <div class="dashboard">
        <header class="header">
            <div class="logo">BEATSTREET <span style="color:var(--primary-cyan)">PROXY V3</span></div>
            <div class="status-bar">
                <div class="status-item"><div class="status-dot"></div> ONLINE</div>
                <div class="status-item"><div class="status-dot" style="background:#00ff00"></div> DIRECT/PROXY</div>
            </div>
        </header>

        <main class="main-content">
            <section class="panel">
                <div class="panel-title">
                    <span id="playlistTitle">DATA STREAM [0/0]</span>
                    <div>
                        <button class="select-all-btn" id="selectAllBtn">
                            <i class="fas fa-check-double"></i> SELECT ALL AUDIO
                        </button>
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="playlist-container" id="playlistContainer">
                    <div style="text-align:center; color:var(--text-secondary); padding:30px; opacity:0.5;">NO DATA</div>
                </div>
                <button class="action-btn download-zip-btn" id="downloadZipBtn">
                    <i class="fas fa-file-archive"></i> ZIP SELECTED
                    <small id="selectedCountBadge">(0)</small>
                </button>
                <button class="action-btn test-download-btn" id="testDownloadBtn">
                    <i class="fas fa-bolt"></i> FAST TEST (10 FILES)
                </button>
                <button class="action-btn download-all-btn" id="downloadAllBtn">
                    <i class="fas fa-rocket"></i> DOWNLOAD ALL AUDIO
                </button>
            </section>

            <section class="panel media-deck">
                <div class="deck-input-group">
                    <input type="text" class="cyber-input" id="urlInput" placeholder="ENTER YOUTUBE URL OR MP3 LINK...">
                    <button class="cyber-btn" id="loadBtn">LOAD</button>
                </div>

                <div class="screen-container" id="screenContainer">
                    <div class="corner-decor tl"></div>
                    <div class="corner-decor br"></div>
                    <div class="scanlines"></div>

                    <div class="screen-content active" id="ytScreen">
                        <div class="yt-placeholder" id="ytPlaceholder">
                            <i class="fab fa-youtube"></i><br>READY TO PLAY
                        </div>
                        <div class="yt-player-container" id="ytPlayerContainer"></div>
                    </div>

                    <div class="screen-content" id="audioScreen">
                        <div class="audio-player-ui">
                            <div class="audio-info-title" id="audioTitle">NO TRACK</div>
                            <div class="audio-info-path" id="audioPath">WAITING...</div>
                            <div class="audio-wave">
                                <div class="bar" style="animation-delay:0.1s"></div>
                                <div class="bar" style="animation-delay:0.3s"></div>
                                <div class="bar" style="animation-delay:0.5s"></div>
                                <div class="bar" style="animation-delay:0.2s"></div>
                                <div class="bar" style="animation-delay:0.4s"></div>
                            </div>
                        </div>
                        <audio id="html5Audio" controls style="width:100%; position:absolute; bottom:0; opacity:0;"></audio>
                    </div>
                </div>

                <div class="control-bar">
                    <div class="bar-left">
                        <span id="modeIndicator">MODE: YOUTUBE</span>
                        <br>
                        <span id="statusIndicator" style="color:var(--primary-cyan)">⚡ READY</span>
                    </div>
                    <div class="bar-controls">
                        <button class="icon-btn" id="prevBtn"><i class="fas fa-step-backward"></i></button>
                        <button class="icon-btn" id="playPauseBtn"><i class="fas fa-play"></i></button>
                        <button class="icon-btn" id="nextBtn"><i class="fas fa-step-forward"></i></button>
                        <button class="mp3-action-btn" id="mp3ActionBtn"><i class="fas fa-download"></i> GET MP3</button>
                    </div>
                </div>
            </section>

            <section class="panel">
                <div class="panel-title">CONTROLS</div>
                <div style="margin-top:auto; text-align:center;">
                    <button class="cyber-btn" onclick="openScanner()" style="width:100%; margin-bottom:10px; border-color:var(--accent-blue); color:var(--accent-blue);">
                        <i class="fas fa-search"></i> DEEP SCAN
                    </button>
                    <button class="cyber-btn" id="clearPlaylistBtn" style="width:100%; background:rgba(255,0,0,0.1); border-color:red; color:red;">
                        <i class="fas fa-trash"></i> CLEAR ALL
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- SCANNER OVERLAY -->
    <div class="overlay" id="scannerOverlay">
        <div class="overlay-box">
            <h2 style="font-family:'Orbitron'; color:var(--primary-cyan);">RECURSIVE CRAWLER V3</h2>
            <input type="text" class="cyber-input" id="scanInput" value="https://icekolkut.website/music2709/ice%20cube%20-19%20albums-320kbps/" style="margin-top:20px;">
            
            <!-- Mode Direct Toggle -->
            <label class="toggle-wrapper">
                <input type="checkbox" class="toggle-checkbox" id="directModeCheck">
                <div class="toggle-slider"></div>
                <div style="text-align:left;">
                    <strong>DIRECT MODE (No Proxy)</strong><br>
                    <small style="color:#666">Use with CORS Extension. Bypasses Cloudflare.</small>
                </div>
            </label>

            <div class="scan-log" id="scanLog">> System ready...</div>
            <div style="margin-top:15px;">
                <button class="cyber-btn" id="startScanBtn" style="background:rgba(0,255,0,0.1); border-color:#0f0; color:#0f0;">START CRAWL</button>
                <button class="cyber-btn" id="stopScanBtn" style="background:rgba(255,0,0,0.1); border-color:red; color:red; display:none;">
                    <i class="fas fa-stop"></i> STOP SCAN
                </button>
                <button class="cyber-btn" onclick="closeScanner()" style="margin-left:10px;">CLOSE</button>
            </div>
        </div>
    </div>

    <!-- ZIP PROGRESS OVERLAY -->
    <div class="overlay" id="zipOverlay">
        <div class="overlay-box" style="width: 600px;">
            <h2 style="font-family:'Orbitron'; color:var(--primary-cyan); margin-bottom:15px;">⚡ WORKER PROCESSING</h2>
            <div id="zipStatusText">Initializing Worker...</div>
            <div class="zip-bar-bg">
                <div class="zip-bar-fill" id="zipProgressBar"></div>
            </div>
            <div id="zipSpeedInfo" style="margin-top:10px; font-size:12px; color:var(--text-secondary);"></div>
            <div style="margin-top:15px;">
                <button class="cyber-btn" id="cancelZipBtn" style="background:rgba(255,0,0,0.1); border-color:red; color:red;">
                    <i class="fas fa-stop"></i> CANCEL
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- NOTIFICATIONS ---
        function showNotification(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // --- ENCODING ---
        function fixMojibake(str) {
            if (!str) return '';
            const map = [
                { from: /Ã©/g, to: 'é' }, { from: /Ã¨/g, to: 'è' }, { from: /Ã¢/g, to: 'â' },
                { from: /Ã´/g, to: 'ô' }, { from: /Ã¹/g, to: 'ù' }, { from: /Ãª/g, to: 'ê' },
                { from: /Ã®/g, to: 'î' }, { from: /Ã«/g, to: 'ë' }, { from: /Ã¯/g, to: 'ï' },
                { from: /Ã /g, to: 'à' }, { from: /Ã§/g, to: 'ç' }, { from: /â€™/g, to: "'" },
                { from: /â€"/g, to: '"' }, { from: /â€“/g, to: '–' }, { from: /â€”/g, to: '—' }
            ];
            let res = str;
            map.forEach(m => res = res.replace(m.from, m.to));
            return res;
        }

        // --- PARTICLES ---
        const cyberBg = document.getElementById('cyberBg');
        for(let i=0; i<40; i++) {
            const p = document.createElement('div'); p.className='particle';
            p.style.left = Math.random()*100+'%'; p.style.animationDelay = Math.random()*20+'s';
            cyberBg.appendChild(p);
        }

        let playlist = [];
        let selectedUids = new Set();
        let currentIndex = -1;
        let currentMediaItem = null;
        let isSelectAll = false;
        let zipWorker = null;

        const screens = { yt: document.getElementById('ytScreen'), audio: document.getElementById('audioScreen') };
        const urlInput = document.getElementById('urlInput');
        const statusIndicator = document.getElementById('statusIndicator');
        const playlistTitle = document.getElementById('playlistTitle');
        const selectedCountBadge = document.getElementById('selectedCountBadge');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const ytPlaceholder = document.getElementById('ytPlaceholder');
        const ytPlayerContainer = document.getElementById('ytPlayerContainer');
        const audioEl = document.getElementById('html5Audio');
        const audioTitle = document.getElementById('audioTitle');
        const audioPath = document.getElementById('audioPath');
        const mp3ActionBtn = document.getElementById('mp3ActionBtn');

        // --- WEB WORKER ---
        const workerScript = `
        importScripts('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
        let zip = null;
        let isProcessing = false;
        const proxies = [
            (u) => \`https://corsproxy.io/?\${encodeURIComponent(u)}\`,
            (u) => \`https://api.allorigins.win/get?url=\${encodeURIComponent(u)}\`,
            (u) => \`https://api.codetabs.com/v1/proxy?quest=\${encodeURIComponent(u)}\`
        ];

        function cleanName(name) {
            let n = name.replace(/[<>:"|?*]/g, '_').replace(/\\\\/g, '-');
            if (!n.toLowerCase().endsWith('.mp3')) n += '.mp3';
            return n.substring(0, 100);
        }

        self.onmessage = async function(e) {
            const { action, payload } = e.data;
            if (action === 'start') {
                isProcessing = true;
                const { files, concurrency } = payload;
                zip = new JSZip();
                let processed = 0, success = 0, failed = 0;
                const total = files.length;
                const progress = (c, s, f, t) => {
                    self.postMessage({ type: 'progress', processed: c, total, success: s, failed: f, text: t });
                };
                progress(0, 0, 0, "Initializing worker...");
                for (let i = 0; i < total; i += concurrency) {
                    if (!isProcessing) break;
                    const chunk = files.slice(i, i + concurrency);
                    const promises = chunk.map(file => downloadFile(file, zip));
                    const results = await Promise.allSettled(promises);
                    results.forEach(res => { if (res.status === 'fulfilled') success++; else failed++; });
                    processed += chunk.length;
                    progress(processed, success, failed, \`Downloading chunk \${Math.ceil(processed/concurrency)}...\`);
                }
                if (!isProcessing) { self.postMessage({ type: 'cancelled' }); return; }
                progress(total, success, failed, "Compressing archive (STORE mode)...");
                try {
                    const blob = await zip.generateAsync({ type: "blob", compression: "STORE", platform: "UNIX" });
                    self.postMessage({ type: 'done', blob, success, failed });
                } catch (err) { self.postMessage({ type: 'error', message: err.message }); }
            }
            if (action === 'cancel') { isProcessing = false; }
        };

        async function downloadFile(file, zip) {
            for (const proxyFn of proxies) {
                if (!isProcessing) throw new Error("Cancelled");
                try {
                    const proxyUrl = proxyFn(file.url);
                    const res = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
                    if (!res.ok) throw new Error(\`HTTP \${res.status}\`);
                    let blob;
                    if(proxyUrl.includes('allorigins')) { const json = await res.json(); blob = base64ToBlob(json.contents); }
                    else { blob = await res.blob(); }
                    if (blob.size < 5000) throw new Error("File too small");
                    const path = file.path ? file.path + '/' + cleanName(file.name) : cleanName(file.name);
                    zip.file(path, blob);
                    return true;
                } catch (e) { continue; }
            }
            throw new Error("All proxies failed");
        }
        function base64ToBlob(base64, type = 'audio/mpeg') {
            const binStr = atob(base64); const len = binStr.length; const arr = new Uint8Array(len);
            for (let i = 0; i < len; i++) arr[i] = binStr.charCodeAt(i);
            return new Blob([arr], { type: type });
        }
        `;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);

        class ZipWorkerManager {
            constructor() {
                this.worker = new Worker(workerUrl);
                this.worker.onmessage = this.handleMessage.bind(this);
                this.isBusy = false;
            }
            handleMessage(e) {
                const { type, blob, success, failed, processed, total, text, percent, message } = e.data;
                if (type === 'progress') {
                    document.getElementById('zipProgressBar').style.width = `${Math.round((processed/total)*100)}%`;
                    document.getElementById('zipStatusText').innerHTML = `${text}<br><small>${processed}/${total} • ✅${success} • ❌${failed}</small>`;
                    document.getElementById('zipSpeedInfo').textContent = `Processing ${processed} files...`;
                } else if (type === 'done') {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a'); link.href = url; link.download = `Beatstreet_${new Date().toISOString().slice(0,10)}.zip`;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url);
                    this.cleanup();
                    showNotification(`✅ COMPLETE! ${success} files downloaded.`, 'success');
                } else if (type === 'cancelled' || type === 'error') {
                    showNotification(type==='cancelled' ? 'Download cancelled' : `❌ Error: ${message}`, type==='cancelled'?'info':'error');
                    this.cleanup();
                }
            }
            start(files, isTest = false) {
                if (this.isBusy) return;
                const items = isTest ? files.slice(0, 10) : files;
                const cleanItems = items.map(item => ({ url: item.url, name: item.name, path: item.path || '' }));
                this.isBusy = true;
                document.getElementById('zipOverlay').style.display = 'flex';
                document.getElementById('zipProgressBar').style.width = '0%';
                document.getElementById('cancelZipBtn').style.display = 'inline-block';
                this.worker.postMessage({ action: 'start', payload: { files: cleanItems, concurrency: 8 } });
            }
            cancel() { if (this.worker) this.worker.postMessage({ action: 'cancel' }); }
            cleanup() { this.isBusy = false; document.getElementById('zipOverlay').style.display = 'none'; document.getElementById('cancelZipBtn').style.display = 'none'; }
        }
        const zipManager = new ZipWorkerManager();
        document.getElementById('cancelZipBtn').onclick = () => zipManager.cancel();

        // --- PLAYER ---
        class SmartYouTubePlayer {
            playVideo(videoId, autoplay) {
                ytPlaceholder.style.display = 'flex'; ytPlaceholder.innerHTML = `<i class="fab fa-youtube"></i><br>INITIALIZING...`;
                ytPlayerContainer.innerHTML = '';
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=${autoplay?1:0}&playsinline=1`;
                iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border = 'none';
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                ytPlayerContainer.appendChild(iframe);
                setTimeout(() => { ytPlaceholder.style.display = 'none'; statusIndicator.textContent = autoplay ? "PLAYING" : "READY"; }, 1000);
            }
            stop() { ytPlayerContainer.innerHTML = ''; ytPlaceholder.style.display = 'flex'; ytPlaceholder.innerHTML = `<i class="fab fa-youtube"></i><br>READY`; }
        }
        const youtubePlayer = new SmartYouTubePlayer();

        function switchScreen(type) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            if (type === 'youtube') { screens.yt.classList.add('active'); document.getElementById('modeIndicator').textContent = "MODE: YOUTUBE"; mp3ActionBtn.classList.add('show'); }
            else { screens.audio.classList.add('active'); document.getElementById('modeIndicator').textContent = "MODE: AUDIO STREAM"; mp3ActionBtn.classList.remove('show'); }
        }

        function playMedia(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index; currentMediaItem = playlist[index]; renderPlaylist();
            if (currentMediaItem.type === 'youtube') {
                switchScreen('youtube');
                const id = extractYTId(currentMediaItem.url);
                if(id) { youtubePlayer.playVideo(id, false); mp3ActionBtn.onclick = () => { window.open(`https://www.y2mate.com/youtube/${id}`, '_blank'); }; }
            } else {
                switchScreen('audio'); audioEl.src = currentMediaItem.url; audioEl.play();
                audioTitle.textContent = fixMojibake(currentMediaItem.name);
                audioPath.textContent = currentMediaItem.path ? fixMojibake(currentMediaItem.path) : "/";
                statusIndicator.textContent = "PLAYING"; document.querySelector('#playPauseBtn i').className = 'fas fa-pause';
            }
        }
        document.getElementById('loadBtn').onclick = () => {
            const url = urlInput.value.trim(); if (!url) return;
            if (url.includes('youtube.com') || url.includes('youtu.be')) { const id = extractYTId(url); if(id) { addToPlaylist(url, `YouTube: ${id}`, 'youtube'); playMedia(playlist.length-1); } }
            else if (url.endsWith('.mp3')) { const name = url.split('/').pop(); addToPlaylist(url, name, 'audio'); playMedia(playlist.length-1); }
            else { document.getElementById('scanInput').value = url; openScanner(); }
        };
        document.getElementById('playPauseBtn').onclick = () => {
            const icon = document.querySelector('#playPauseBtn i');
            if (currentMediaItem?.type === 'audio') { if(audioEl.paused) { audioEl.play(); icon.className='fas fa-pause'; statusIndicator.textContent="PLAYING"; } else { audioEl.pause(); icon.className='fas fa-play'; statusIndicator.textContent="PAUSED"; } }
        };
        document.getElementById('nextBtn').onclick = () => playMedia((currentIndex+1)%playlist.length);
        document.getElementById('prevBtn').onclick = () => playMedia((currentIndex-1+playlist.length)%playlist.length);

        function addToPlaylist(url, name, type, path='') {
            const uid = Date.now().toString(36)+Math.random().toString(36).substr(2);
            playlist.push({ url, name, type, path, uid }); renderPlaylist();
        }
        function toggleSelection(uid) { if(selectedUids.has(uid)) selectedUids.delete(uid); else selectedUids.add(uid); updateSelectAllState(); renderPlaylist(); }
        function updateSelectAllState() {
            const allAudio = playlist.filter(i => i.type === 'audio'); const allSelected = allAudio.length > 0 && allAudio.every(item => selectedUids.has(item.uid));
            isSelectAll = allSelected; selectAllBtn.innerHTML = allSelected ? '<i class="fas fa-times"></i> DESELECT ALL' : '<i class="fas fa-check-double"></i> SELECT ALL AUDIO';
        }
        function deleteTrack(uid, e) { if(e) e.stopPropagation(); playlist = playlist.filter(item => item.uid !== uid); selectedUids.delete(uid); updateSelectAllState(); renderPlaylist(); }
        function renderPlaylist() {
            const container = document.getElementById('playlistContainer'); container.innerHTML = '';
            if(playlist.length === 0) { container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:30px;">NO DATA</div>'; playlistTitle.textContent = "DATA STREAM [0/0]"; selectedCountBadge.textContent = "(0)"; return; }
            playlist.forEach((item, idx) => {
                const div = document.createElement('div'); const isSelected = selectedUids.has(item.uid); div.className = `playlist-item ${idx===currentIndex?'active':''}`;
                const displayName = fixMojibake(item.name);
                let pathDisplay = '';
                if (item.path && item.path !== '/') { const parts = fixMojibake(item.path).split('/').filter(p=>p); pathDisplay = parts.join(' <i class="fas fa-chevron-right" style="font-size:8px; margin:0 2px;"></i> '); }
                div.innerHTML = `<div class="cyber-check ${isSelected?'checked':''}" onclick="toggleSelection('${item.uid}')"></div><div class="track-info-wrapper"><div class="track-path">${pathDisplay}</div><div class="track-name">${item.type==='youtube'?'<i class="fab fa-youtube" style="color:red"></i>':'<i class="fas fa-music"></i>'} ${displayName}</div></div><div class="delete-btn" onclick="deleteTrack('${item.uid}', event)"><i class="fas fa-times"></i></div>`;
                div.addEventListener('click', (e) => { if(!e.target.classList.contains('cyber-check') && !e.target.closest('.delete-btn')) playMedia(idx); }); container.appendChild(div);
            });
            const audioCount = playlist.filter(i => i.type === 'audio').length;
            playlistTitle.textContent = `DATA STREAM [${selectedUids.size}/${audioCount}]`; selectedCountBadge.textContent = `(${selectedUids.size})`;
        }
        function extractYTId(url) { const reg = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i; const match = url.match(reg); return match ? match[1] : null; }

        // --- ADVANCED SCANNER LOGIC (V3) ---
        window.openScanner = () => document.getElementById('scannerOverlay').style.display = 'flex';
        window.closeScanner = () => document.getElementById('scannerOverlay').style.display = 'none';

        // Liste de proxys réorganisée (Codetabs en premier pour les serveurs bloquant le reste)
        const SCAN_PROXIES = [
            (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`, // AWS IP, robuste
            (u) => `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(u)}`, // Bon fallback
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`
        ];

        async function fetchContent(url, useDirect) {
            const log = document.getElementById('scanLog');
            
            // 1. Tentative DIRECT (Mode Hack)
            if (useDirect) {
                try {
                    log.innerHTML += `<div class="info">Trying DIRECT request (Requires CORS Extension)...</div>`;
                    log.scrollTop = log.scrollHeight;
                    const response = await fetch(url, { signal: AbortSignal.timeout(10000) });
                    if (response.ok) {
                        const text = await response.text();
                        if(text.length > 200 && (text.includes('<html') || text.includes('<body'))) return text;
                        throw new Error("Direct response too small or invalid");
                    }
                    throw new Error(`Direct request blocked (HTTP ${response.status})`);
                } catch (err) {
                    log.innerHTML += `<div class="error">Direct Mode Failed: ${err.message}</div>`;
                    log.scrollTop = log.scrollHeight;
                    // Si le direct échoue, on continue normalement avec les proxies
                }
            }

            // 2. Tentative via Proxies
            for (let i = 0; i < SCAN_PROXIES.length; i++) {
                const proxyUrl = SCAN_PROXIES[i](url);
                const proxyName = proxyUrl.split('//')[1].split('/')[0];
                
                if(log) log.innerHTML += `<div class="warning">Trying Proxy: ${proxyName}...</div>`;
                log.scrollTop = log.scrollHeight;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); 

                    const response = await fetch(proxyUrl, {
                        signal: controller.signal,
                        headers: { 'Accept': 'text/html,application/xhtml+xml' } 
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        if(response.status === 403) {
                            throw new Error(`CLOUDFLARE/BLOCK (403) - Proxy blacklisted.`);
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const text = await response.text();

                    if (text.length < 200) throw new Error("Empty response");
                    if (!text.includes('<html') && !text.includes('<HTML') && !text.includes('<body')) throw new Error("Not HTML");

                    return text; // Succès

                } catch (err) {
                    console.warn(`Proxy ${i+1} failed:`, err);
                    if(log) log.innerHTML += `<div class="error">Failed: ${err.message}</div>`;
                    log.scrollTop = log.scrollHeight;
                    continue;
                }
            }
            
            throw new Error("All methods failed. Target likely blocks proxies.");
        }

        let isScanning = false;
        document.getElementById('startScanBtn').onclick = async () => {
            const startUrl = document.getElementById('scanInput').value.trim();
            if(!startUrl) return;

            const isDirect = document.getElementById('directModeCheck').checked;

            isScanning = true;
            document.getElementById('startScanBtn').style.display = 'none';
            document.getElementById('stopScanBtn').style.display = 'inline-block';
            const log = document.getElementById('scanLog');
            log.innerHTML = "";

            const l = (msg, type='') => {
                const div = document.createElement('div');
                div.textContent = msg;
                if(type==='found') div.className='found';
                if(type==='error') div.className='error';
                log.appendChild(div);
                log.scrollTop = log.scrollHeight;
            };

            try {
                let baseUrlObj = new URL(startUrl);
                if (!baseUrlObj.pathname.endsWith('/')) baseUrlObj.pathname += '/';
                const baseUrl = baseUrlObj.href;
                const basePath = baseUrlObj.pathname;

                l(`Starting Scan: ${baseUrl}`);
                l(`Mode: ${isDirect ? 'DIRECT (Extension Required)' : 'PROXY ROTATION'}`);
                
                const queue = [{ url: baseUrl, depth: 0 }];
                const visited = new Set();
                const maxDepth = 10;

                while(queue.length > 0 && isScanning) {
                    const { url, depth } = queue.shift();
                    
                    if(visited.has(url)) continue;
                    visited.add(url);

                    const currentUrlObj = new URL(url);
                    if (!currentUrlObj.pathname.startsWith(basePath)) {
                        l(`Skipped (Outside root): ${url}`, 'warning');
                        continue;
                    }

                    const relativePath = currentUrlObj.pathname.substring(basePath.length);
                    l(`Scanning: ${relativePath || '/'} (Depth: ${depth})`);

                    try {
                        const html = await fetchContent(url, isDirect);
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const links = Array.from(doc.querySelectorAll('a[href]'));

                        links.forEach(link => {
                            const href = link.getAttribute('href');
                            if(!href || href.startsWith('#') || href.includes('?')) return;
                            if(href === '../' || href.startsWith('../')) return; 
                            if(href.startsWith('mailto:') || href.startsWith('javascript:')) return;

                            try {
                                const resolvedUrl = new URL(href, url).href;
                                const resolvedUrlObj = new URL(resolvedUrl);
                                if(resolvedUrlObj.origin !== baseUrlObj.origin) return;
                                if(!resolvedUrlObj.pathname.startsWith(basePath)) return;

                                if(resolvedUrl.endsWith('/')) {
                                    if(depth < maxDepth && !visited.has(resolvedUrl)) queue.push({ url: resolvedUrl, depth: depth + 1 });
                                } else if(resolvedUrl.toLowerCase().endsWith('.mp3')) {
                                    const name = resolvedUrl.split('/').pop();
                                    const path = resolvedUrlObj.pathname.substring(basePath.length).replace(name,'');
                                    addToPlaylist(resolvedUrl, name, 'audio', path);
                                    l(`  + FOUND: ${name}`, 'found');
                                }
                            } catch(e) { }
                        });
                        
                        await new Promise(r => setTimeout(r, 200)); 

                    } catch(e) {
                        l(`Error scanning folder: ${e.message}`, 'error');
                    }
                }
            } catch(e) {
                l(`Critical Scan Error: ${e.message}`, 'error');
            }
            
            if(!isScanning) l("SCAN STOPPED BY USER.");
            else l("SCAN COMPLETE.");
            
            document.getElementById('startScanBtn').style.display = 'inline-block';
            document.getElementById('stopScanBtn').style.display = 'none';
            isScanning = false;
        };
        
        document.getElementById('stopScanBtn').onclick = () => { isScanning = false; l("Stopping...", 'warning'); };

        // --- GLOBAL ACTIONS ---
        document.getElementById('clearPlaylistBtn').onclick = () => {
            playlist = []; selectedUids.clear(); currentIndex = -1;
            updateSelectAllState(); renderPlaylist();
            youtubePlayer.stop(); audioEl.pause();
            showNotification("Playlist cleared", "info");
        };

        selectAllBtn.onclick = () => {
            if (isSelectAll) { selectedUids.clear(); showNotification("Deselected", "info"); }
            else { playlist.forEach(item => { if(item.type === 'audio') selectedUids.add(item.uid); }); showNotification(`Selected ${selectedUids.size} files`, "success"); }
            isSelectAll = !isSelectAll; updateSelectAllState(); renderPlaylist();
        };

        async function startDownloadProcess(isTest = false) {
            let audioItems = [];
            if (isTest) {
                 if(selectedUids.size === 0) audioItems = playlist.filter(i => i.type === 'audio').slice(0, 10);
                 else audioItems = playlist.filter(i => selectedUids.has(i.uid) && i.type === 'audio').slice(0, 10);
            } else {
                if (selectedUids.size === 0) { showNotification("Please select files first.", "warning"); return; }
                audioItems = playlist.filter(i => selectedUids.has(i.uid) && i.type === 'audio');
            }
            if (audioItems.length === 0) { showNotification("No audio files found.", "error"); return; }
            zipManager.start(audioItems, isTest);
        }

        document.getElementById('downloadZipBtn').onclick = () => startDownloadProcess(false);
        document.getElementById('testDownloadBtn').onclick = () => startDownloadProcess(true);
        downloadAllBtn.onclick = () => {
            selectedUids.clear(); playlist.forEach(item => { if(item.type === 'audio') selectedUids.add(item.uid); });
            isSelectAll = true; renderPlaylist(); startDownloadProcess(false);
        };

        window.addEventListener('DOMContentLoaded', () => { 
            showNotification("Proxy V3 loaded. Use Direct Mode + Extension for best results.", "info"); 
        });
    </script>
</body>
</html>
